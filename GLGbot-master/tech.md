# Техническое задание на разработку Telegram бота для грузоперевозок

## Используемый стек технологий

- **Python** 3.10+
- **Aiogram** 3.x - фреймворк для создания Telegram ботов
- **SQLite3** - реляционная база данных для хранения информации
- **Logging** - встроенная библиотека для логирования событий
- **Pillow** - для обработки изображений
- **PyMuPDF** - для работы с PDF-документами
- **aiofiles** - для асинхронной работы с файлами

## Структура проекта

```
/src
  /database
    - db.py (инициализация БД)
    - models.py (модели данных)
    - crud.py (операции с БД)
  /handlers
    - start.py (обработка команд /start, приветствие)
    - registration.py (регистрация пользователей)
    - orders.py (создание и обработка заявок)
    - documents.py (загрузка и обработка документов)
  /keyboards
    - main_kb.py (основная клавиатура)
    - registration_kb.py (клавиатура регистрации)
    - orders_kb.py (клавиатура заявок)
  /middlewares
    - auth.py (авторизация пользователей)
  /services
    - notifications.py (отправка уведомлений)
    - file_handling.py (обработка файлов)
  /utils
    - states.py (FSM состояния)
    - helpers.py (вспомогательные функции)
  - config.py (конфигурация бота)
  - bot.py (точка входа в приложение)
```

## Детальное техническое задание

### 1. Этап: Разработка основной структуры бота

#### 1.1. Регистрация пользователей

1. Реализовать механизм регистрации пользователей с определением роли:
   - Отправитель груза
   - Перевозчик
2. Собирать и сохранять информацию о пользователе:
   - Имя и фамилия (обязательно)
   - Контактный телефон (обязательно)
   - Email (опционально)
   - Компания (опционально)
3. Сохранять информацию в БД с созданием уникального ID пользователя.
4. Реализовать проверку уже зарегистрированных пользователей при повторном запуске бота.

#### 1.2. Интерфейс бота

1. Создать приветственное сообщение с кратким описанием возможностей бота.
2. Разработать систему навигации с использованием кнопок Telegram InlineKeyboard и ReplyKeyboardMarkup.
3. Реализовать основные разделы интерфейса:
   - Личный кабинет
   - Создание заявки (для отправителей)
   - Поиск заявок (для перевозчиков)
   - Мои заявки/заказы
   - Информация/Помощь
4. Обеспечить интуитивно понятный интерфейс с минимальным количеством действий для выполнения задач.

#### 1.3. Интеграция с Telegram Bot API

1. Настроить работу с Telegram Bot API через библиотеку Aiogram 3.x.
2. Обеспечить обработку основных типов сообщений:
   - Текстовые сообщения
   - Документы
   - Изображения
   - Контакты
3. Настроить обработку callback-запросов от InlineKeyboard.
4. Реализовать систему состояний FSM для мультишаговых процессов.

#### 1.4. База данных

1. Спроектировать и создать схему базы данных SQLite3 со следующими таблицами:
   - Users (пользователи)
   - Orders (заявки на перевозку)
   - Documents (документы)
   - OrderStatus (статусы заявок)
2. Определить необходимые связи между таблицами.
3. Обеспечить атомарность операций с базой данных.
4. Реализовать CRUD-операции для всех таблиц.

#### 1.5. Система создания заявок

1. Реализовать пошаговое создание заявки с использованием FSM:
   - Тип груза (стандартный, негабаритный, хрупкий и т.д.)
   - Вес груза
   - Размеры груза (опционально)
   - Адрес загрузки
   - Адрес выгрузки
   - Дата загрузки
   - Комментарий (опционально)
2. Предоставить возможность отмены процесса создания заявки на любом этапе.
3. Реализовать предварительный просмотр и подтверждение заявки перед сохранением.

### 2. Этап: Создание и обработка заявок на перевозку и интеграция с пользователями

#### 2.1. Форма создания заявки

1. Разработать удобную форму создания заявки с минимальным количеством шагов.
2. Обеспечить валидацию вводимых данных:
   - Проверка корректности формата данных
   - Проверка обязательных полей
3. Предоставить возможность добавления дополнительных характеристик груза.
4. Реализовать выбор типа транспорта (при необходимости).

#### 2.2. Загрузка и хранение документов

1. Обеспечить возможность загрузки документов различных форматов:
   - PDF (ТТН, инвойсы)
   - Изображения (фото груза)
2. Реализовать проверку размера и формата загружаемых файлов.
3. Обеспечить безопасное хранение файлов с уникальными идентификаторами.
4. Предоставить возможность просмотра и удаления загруженных документов.

#### 2.3. Система уведомлений

1. Реализовать отправку уведомлений пользователям о:
   - Создании новой заявки
   - Появлении новых заявок для перевозчиков
   - Принятии заявки перевозчиком
   - Изменении статуса заявки
   - Завершении перевозки
2. Разработать механизм фильтрации уведомлений по релевантности для перевозчиков.
3. Обеспечить возможность настройки уведомлений пользователем.

#### 2.4. Система поиска и отображения заказов

1. Реализовать механизм отображения новых заказов для перевозчиков:
   - Отображение краткой информации о заказе
   - Возможность просмотра детальной информации
   - Фильтрация заказов по параметрам (местоположение, тип груза и т.д.)
2. Обеспечить актуальность отображаемой информации.
3. Реализовать пагинацию при большом количестве заказов.

#### 2.5. Функционал принятия заказов

1. Разработать механизм принятия заказов перевозчиками:
   - Кнопка "Принять заказ" в детальной информации
   - Подтверждение принятия заказа
2. Обеспечить блокировку заказа после принятия одним перевозчиком.
3. Реализовать систему отмены принятия заказа (при необходимости).

#### 2.6. Обмен контактными данными

1. Реализовать механизм обмена контактными данными после принятия заказа:
   - Отправка контактных данных отправителя перевозчику
   - Отправка контактных данных перевозчика отправителю
2. Обеспечить защиту персональных данных до момента подтверждения заказа.
3. Предоставить возможность связи через бота (опционально).

#### 2.7. Завершение доставки

1. Реализовать механизм подтверждения завершения доставки:
   - Кнопка "Доставка выполнена" для перевозчика
   - Кнопка "Подтвердить получение" для отправителя
2. Обеспечить изменение статуса заказа после подтверждения обеими сторонами.
3. Реализовать возможность оставления отзыва (опционально).

## Требования к коду и разработке

1. Модульная структура с разделением кода на логические компоненты.
2. Каждый файл должен содержать не более 300-500 строк кода.
3. Использование типизации для улучшения качества кода.
4. Обработка всех возможных исключений и ошибок.
5. Асинхронное выполнение длительных операций.
6. Логирование ключевых событий и ошибок.
7. Оптимизация запросов к базе данных.
8. Вместо команд использовать кнопки под полем ввода текста (ReplyKeyboardMarkup).
9. Использование дружелюбных приветствий и сообщений для улучшения пользовательского опыта.

## Дополнительные требования

1. Простой и интуитивно понятный пользовательский интерфейс.
2. Минимальное количество шагов для выполнения основных операций.
3. Информативные сообщения об ошибках.
4. Быстрая обработка запросов.
5. Корректная работа в условиях высокой нагрузки.
6. Обеспечение безопасности данных пользователей.
7. Поддержка русского языка в интерфейсе.
